#!/usr/bin/env bash

set -euo pipefail

CONFIG_PATH="$HOME/.config/envsecret"
mkdir -p "$CONFIG_PATH"

VAULT="pb"
declare "OP_SESSION_$VAULT=$(op signin --shorthand=${VAULT} --output=raw)"
TAG="environment-variable"

UUIDS=$(op list items | jq ".[] | select(contains({overview: {tags: [\"$TAG\"]}})) | .uuid" -r)
TEMP_FILE="$(mktemp)"

{
  echo "# Generated by $0"
  echo "# Edit that not this"
  echo '# Tag stuff in 1password with "environment-variable" to make this script find it'
  echo "# usernames become key names, and passwords the values"
  echo
} >>"$TEMP_FILE"

while read -r UUID; do
  ITEM="$(op get item "$UUID")"
  KEY=$(echo "$ITEM" | jq '.details.fields[] | select(.name == "username") | .value' -r)
  PASSWORD=$(echo "$ITEM" | jq '.details.fields[] | select(.name == "password") | .value')

  echo "export $KEY=$PASSWORD" >>"$TEMP_FILE"
done <<<"$UUIDS"

echo "export LAPTOP_NAME=$LAPTOP_NAME" >>"$TEMP_FILE"

mv "$TEMP_FILE" "$CONFIG_PATH/envsecret"
