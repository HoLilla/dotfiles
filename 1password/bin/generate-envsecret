#!/usr/bin/env bash

set -euo pipefail

CONFIG_PATH="$HOME/.config/envsecret"
mkdir -p "$CONFIG_PATH"

VAULT="pb"
declare "OP_SESSION_$VAULT=$(op signin ${VAULT} --output=raw)"
TAG="environment-variable"

UUIDS=$(op list items | jq ".[] | select(contains({overview: {tags: [\"$TAG\"]}})) | .uuid" -r)
SH_TEMP_FILE="$(mktemp)"
FISH_TEMP_FILE="$(mktemp)"

{
  echo "# Generated by $0"
  echo "# Edit that not this"
  echo '# Tag stuff in 1password with "environment-variable" to make this script find it'
  echo "# usernames become key names, and passwords the values"
  echo
} >>"$SH_TEMP_FILE"

cp "$SH_TEMP_FILE" "$FISH_TEMP_FILE"

while read -r UUID; do
  ITEM="$(op get item "$UUID")"
  KEY=$(echo "$ITEM" | jq -r '.details.fields[] | select(.name == "username") | .value')
  PASSWORD=$(echo "$ITEM" | jq -r '.details.fields[] | select(.name == "password") | .value')

  echo "export \"$KEY\"=\"$PASSWORD\"" >>"$SH_TEMP_FILE"
  echo "set -xg \"$KEY\" \"$PASSWORD\"" >>"$FISH_TEMP_FILE"
done <<<"$UUIDS"

mv "$SH_TEMP_FILE" "$CONFIG_PATH/envsecret.sourceable.sh"
sops -i --encrypt "$CONFIG_PATH/envsecret.sourceable.sh"

mv "$FISH_TEMP_FILE" "$CONFIG_PATH/envsecret.sourceable.fish"
sops -i --encrypt "$CONFIG_PATH/envsecret.sourceable.fish"

